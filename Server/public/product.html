<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>4CE Магазин</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="MainCSS.css">
</head>
<body>
    <header>
        <div class="menu">
            <nav class="top-nav">                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   
                <a href="WishlistHTML.html">Закладки</a>
                <a href="CompareHTML.html">Сравнение</a>
                <a href="BasketHTML.html">Корзина</a>
                <div style="white-space: nowrap;">
                    <img src="pictures\Telephone.png" alt="Telephone" class="telephone-icon">
                    8(952)&nbsp;570-76-95
                </div>
                <a href="PickupHTML.html">Самовывоз</a>
                <a href="DeliveryHTML.html">Доставка</a>
                <a href="PaymentHTML.html">Оплата</a>
                <div id="authSection">
                    <a href="#" id="authLink" onclick="event.preventDefault(); openModal();">Вход</a>
                </div>
            </nav>
        </div>
    </header>
    <div id="modal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal()">&times;</span>
            <div class="tabs">
                <button class="tab-btn active" onclick="showTab('login')">Вход</button>
                <button class="tab-btn" onclick="showTab('register')">Регистрация</button>
            </div>
            <div id="login" class="tab-content">
                <h3>Вход</h3>
                <form id="loginForm">
                    <div class="form-group">
                        <label for="email">E-mail</label>
                        <input type="email" id="loginEmail" placeholder="user@example.com" required>
                    </div>
                    <div class="form-group">
                        <label for="password">Пароль</label>
                        <input type="password" id="loginPassword" placeholder="******" required>
                        <span class="password-toggle" onclick="togglePassword('loginPassword')">Показать</span>
                    </div>
                    <button type="submit" class="btn-submit">Войти</button>
                </form>
            </div>
            <div id="register" class="tab-content" style="display: none;">
                <h3>Регистрация</h3>
                <form id="registerForm">
                    <div class="form-group">
                        <label for="regUsername">Имя</label>
                        <input type="text" id="regUsername" placeholder="Иван" required>
                    </div>
                    <div class="form-group">
                        <label for="regSubname">Фамилия</label>
                        <input type="text" id="regSubname" placeholder="Иванов" required>
                    </div>
                    <div class="form-group">
                        <label for="regEmail">E-mail</label>
                        <input type="email" id="regEmail" placeholder="user@example.com" required>
                    </div>
                    <div class="form-group">
                        <label for="regPassword">Пароль</label>
                        <input type="password" id="regPassword" placeholder="******" minlength="8" required>
                        <span class="password-toggle" onclick="togglePassword('regPassword')">Показать</span>
                    </div>
                    <button type="submit" class="btn-submit">Зарегистрироваться</button>
                </form>
            </div>
        </div>
    </div>
    <div class="main">
        <!-- Заменим статический список категорий в aside.catalog на: -->
        <aside class="catalog">
            <h4>магазин игровых товаров</h4>
            <a href="/MainHTML.html">
                <img src="pictures\4CE.png" class="ACE">
            </a>
            <ul id="categories-list">
                <h3>Каталог</h3>
                <!-- Категории будут загружены динамически -->
            </ul>
        </aside>
        <div class="content">
            <form class="poisk_tovary" action="/api/search" method="GET">
                <input type="text" name="query" required>
                <button type="button" id="resetSearch" class="reset-btn">x</button>
                <button type="submit">НАЙТИ</button>
            </form>
            <div class="breadcrumbs" id="breadcrumbs" itemscope itemtype="https://schema.org/BreadcrumbList">
            <!-- Главная страница -->
                <div class="breadcrumb-item" itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem">
                    <a href="MainHTML.html" itemprop="item">
                        <span itemprop="name">Главная</span>
                    </a>
                    <meta itemprop="position" content="1">
                </div>
            <!-- Динамически добавляемые элементы будут здесь -->
            </div>
            <div id="searchResults" class="search-results">
                <!-- Результаты будут вставлены сюда -->
            </div>
            <div id="product-container">
                <h1 id="product-name"></h1>
                <img id="product-image" src="" alt="">
                <div class="product-gallery">
                    <div class="thumbnail-carousel">
                        <button class="carousel-prev">▲</button>
                        <div class="thumbnails-container">
                        </div>
                        <button class="carousel-next">▼</button> 
                    </div>
                    <div class="product-preview">
                        <img id="main-product-image" src="" alt="Основное изображение товара">
                    </div>
                    <div class="product-buy-container">
                        <div id="product-price"></div>
                        <div id="product-stock" class="stock-info"></div>
                        <div class="product-actions">
                            <button class="buy-button">Купить</button>
                            <button class="icon-button" id="wishlistButton">
                                <img src="pictures/heart_icon.png" alt="В избранное">
                            </button>
                            <button class="icon-button" id="compareButton">
                                <img src="pictures/list_icon.png" alt="Сравнить">
                            </button>
                        </div>
                        <div class="product-rating" id="product-rating">
                            <div class="rating-stars" id="rating-stars">
                                <span class="star" data-value="1">&#9733;</span>
                                <span class="star" data-value="2">&#9733;</span>
                                <span class="star" data-value="3">&#9733;</span>
                                <span class="star" data-value="4">&#9733;</span>
                                <span class="star" data-value="5">&#9733;</span>
                            </div>
                            <div class="rating-text" id="rating-text"></div>
                        </div>
                        <div id="product-specs"></div>
                        <div class="product-brand-info">
                            <div class="brand-details">
                                <img id="brand-logo" src="" alt="Логотип бренда" class="brand-logo">
                                <div class="brand-name">Бренд: <span id="brand-name"></span></div>
                                <div class="product-code">Артикул: <span id="product-code"></span></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="product-tabs">
                <div class="tabs">
                    <button class="tab-btn active" onclick="showProductTab('description')">Описание</button>
                    <button class="tab-btn" onclick="showProductTab('specs')">Характеристики</button>
                    <button class="tab-btn" onclick="showProductTab('reviews')">Отзывы</button>
                </div>
                <div id="description" class="tab-content active">
                    <div id="product-description"></div>
                </div>
                <div id="specs" class="tab-content">
                    <div id="product-specs-full"></div>
                </div>
                <div id="reviews" class="tab-content">
                    <div class="reviews-container">
                        <div class="average-rating">
                            <h3>Средний рейтинг:</h3>
                            <p class="rating-value" id="average-rating-value"></p>
                            <p class="recommendation" id="recommendation-percentage"></p>
                            <p class="call-to-action">Успели купить? <a href="#" onclick="showReviewForm()">Оставьте отзыв</a></p>
                        </div>
                        <div class="rating-distribution">
                            <h3>Распределение рейтингов:</h3>
                            <div id="rating-stars-distribution">
                                <!-- Динамически генерируемые рейтинги -->
                            </div>
                        </div>
                        <div class="reviews-section">
                            <h3>Отзывы о товаре:</h3>
                            <div id="reviews-list">
                                <!-- Отзывы будут загружаться динамически -->
                            </div>
                        </div>
                        <!-- Форма добавления отзыва -->
                        <div id="review-form-container" style="display: none;">
                            <h3>Добавить отзыв</h3>
                            <form id="review-form">
                                <div class="form-group">
                                    <label>Оценка:</label>
                                    <div class="rating-input">
                                        <span class="star" data-value="1">★</span>
                                        <span class="star" data-value="2">★</span>
                                        <span class="star" data-value="3">★</span>
                                        <span class="star" data-value="4">★</span>
                                        <span class="star" data-value="5">★</span>
                                    </div>
                                    <input type="hidden" id="review-rating" name="rating" value="0">
                                </div>
                                <div class="form-group">
                                    <label for="review-pros">Достоинства:</label>
                                    <textarea id="review-pros" name="pros" placeholder="Что вам понравилось"></textarea>
                                </div>
                                <div class="form-group">
                                    <label for="review-cons">Недостатки:</label>
                                    <textarea id="review-cons" name="cons" placeholder="Что вам не понравилось"></textarea>
                                </div>
                                <div class="form-group">
                                    <label for="review-comment">Комментарий:</label>
                                    <textarea id="review-comment" name="comment" placeholder="Ваш отзыв"></textarea>
                                </div>
                                <button type="submit" class="btn-submit">Отправить отзыв</button>
                                <button type="button" class="btn-cancel" onclick="hideReviewForm()">Отмена</button>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div id="fullscreenOverlay" class="fullscreen-overlay">
            <span class="close-fullscreen" onclick="closeFullscreen()">&times;</span>
            <img id="fullscreenImage" class="fullscreen-image" src="" alt="Полноэкранное изображение">
        </div>
    </div>
    <footer class="site-footer">
        <div class="footer-container">
            <div class="footer-section">
                <h4>Меню</h4>
                <ul>
                    <li><a href="WishlistHTML.html">Закладки</a></li>
                    <li><a href="CompareHTML.html">Сравнение</a></li>
                    <li><a href="BasketHTML.html">Корзина</a></li>
                    <li><a href="PickupHTML.html">Самовывоз</a></li>
                    <li><a href="DeliveryHTML.html">Доставка</a></li>
                    <li><a href="PaymentHTML.html">Оплата</a></li>
                </ul>
            </div>
            <div class="footer-section">
                <h4>Контакты</h4>
                <ul>
                    <li>
                        <img src="pictures/Telephone_black.png" alt="Телефон" class="footer-icon">
                        8(952) 570-76-95
                    </li>
                    <li>
                        <img src="pictures/Email.png" alt="Email" class="footer-icon">
                        info@4ce-store.ru
                    </li>
                    <li>
                        <img src="pictures/Location.png" alt="Адрес" class="footer-icon">
                        г. Ростов-на-Дону, ул. Тургеневская, 10/6
                    </li>
                </ul>
            </div>
            <div class="footer-section">
                <h4>Социальные сети</h4>
                <div class="social-links">
                    <a href="https://vk.com/pkcu_college"><img src="pictures/VK.png" alt="VK"></a>
                    <a href="https://t.me/rksi_ru"><img src="pictures/Telegram.png" alt="Telegram"></a>
                    <a href="https://vk.com/copprostov"><img src="pictures/YouTube.png" alt="YouTube"></a>
                </div>
                <div class="footer-logo">
                    <a href="/MainHTML.html">
                        <img src="pictures/4CE.png" alt="4CE Магазин">
                    </a>
                </div>
            </div>
        </div>
        <div class="footer-bottom">
            <p>&copy; 2025 4CE Магазин игровых товаров. Все права защищены.</p>
        </div>
    </footer>
    <script>
        // Глобальные переменные
        let currentUser = null;
        // DOM элементы
        const modal = document.getElementById('modal');
        const authSection = document.getElementById('authSection');
        const authLink = document.getElementById('authLink');
        // Функции модального окна
        function openModal() {
            modal.style.display = 'block';
            document.body.style.overflow = 'hidden';
        }
        function closeModal() {
            modal.style.display = 'none';
            document.body.style.overflow = 'auto';
            resetForms();
        }
        function showTab(tabId, event = null) {
            if (event) {
                event.preventDefault();
            }
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.style.display = 'none';
            });
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            document.getElementById(tabId).style.display = 'block';
            if (event) {
            event.currentTarget.classList.add('active');
            } else {
                document.querySelector(`.tab-btn[onclick*="${tabId}"]`).classList.add('active');
            }
        }
        function resetForms() {
            document.getElementById('loginForm').reset();
            document.getElementById('registerForm').reset();
        }
        function togglePassword(inputId) {
            const input = document.getElementById(inputId);
            input.type = input.type === 'password' ? 'text' : 'password';
        }
        // Обновление UI авторизации
        function updateAuthUI(isLoggedIn, userData = null) {
            if (isLoggedIn && userData) {
                currentUser = userData;
                const firstLetter = userData.username.charAt(0).toUpperCase();
                authSection.innerHTML = `
                    <div class="user-avatar">${firstLetter}</div>
                    <a href="AccountHTML.html" id="authLink">${userData.username}</a>
                    <a href="#" id="logoutBtn" class="logout-btn">Выйти</a>
                `;
                document.getElementById('logoutBtn').addEventListener('click', logout);
            } else {
                currentUser = null;
                authSection.innerHTML = `
                    <a href="#" id="authLink" onclick="event.preventDefault(); openModal();">Вход</a>
                `;
            }
        }
        // Выход из системы
        function logout() {
            localStorage.removeItem('token');
            updateAuthUI(false);
            window.location.reload();
        }
        // Проверка авторизации при загрузке
        async function checkAuth() {
            const token = localStorage.getItem('token');
            if (!token) {
                updateAuthUI(false);
                return;
            }
            try {
                const response = await fetch('http://localhost:3000/get-user', {
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });
                if (!response.ok) {
                    if (response.status === 403) {
                        localStorage.removeItem('token');
                        throw new Error('Сессия истекла');
                    }
                    throw new Error('Ошибка сервера');
                }
                const userData = await response.json();
                updateAuthUI(true, userData);
            } catch (error) {
                console.error('Ошибка проверки авторизации:', error);
                alert(error.message);
                updateAuthUI(false);
            }
        }
        // Обработка формы входа
        document.getElementById('loginForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            const email = document.getElementById('loginEmail').value.trim();
            const password = document.getElementById('loginPassword').value;
            if (!email || !password) {
                alert('Заполните все поля');
                return;
            }
            try {
                const response = await fetch('http://localhost:3000/login', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ email, password })
                });
                const data = await response.json();
                if (!response.ok) {
                    throw new Error(data.error || 'Ошибка входа');
                }
                localStorage.setItem('token', data.token);
                updateAuthUI(true, { username: data.username });
                closeModal();
            } catch (error) {
                console.error('Ошибка входа:', error);
                alert(error.message);
            }
        });
        // Обработка формы регистрации
        document.getElementById('registerForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            const userData = {
                username: document.getElementById('regUsername').value.trim(),
                subname: document.getElementById('regSubname').value.trim(),
                email: document.getElementById('regEmail').value.trim(),
                password: document.getElementById('regPassword').value
            };
            if (!userData.username || !userData.subname || !userData.email || !userData.password) {
                alert('Заполните все поля');
                return;
            }
            if (userData.password.length < 8) {
                alert('Пароль должен содержать минимум 8 символов');
                return;
            }
            try {
                const response = await fetch('http://localhost:3000/register', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(userData)
                });
                const data = await response.json();
                if (!response.ok) {
                    throw new Error(data.error || 'Ошибка регистрации');
                }
                alert('Регистрация успешна! Теперь вы можете войти');
                showTab('login');
                document.getElementById('loginEmail').value = userData.email;
                document.getElementById('registerForm').reset();
            } catch (error) {
                console.error('Ошибка регистрации:', error);
                alert(error.message);
            }
        });
        // Закрытие модального окна при клике вне его
        window.addEventListener('click', (e) => {
            if (e.target === modal) {
                closeModal();
            }
        });
    </script>
    <script>
        // Обработчик кнопки "Купить"
        document.querySelector('.buy-button').addEventListener('click', async function() {
            try {
                const urlParams = new URLSearchParams(window.location.search);
                const productId = urlParams.get('id');
                
                if (!productId) {
                    alert('Ошибка: ID товара не определен');
                    return;
                }
                // Получаем данные о товаре
                const productName = document.getElementById('product-name').textContent;
                const productPriceText = document.getElementById('product-price').textContent;
                const productPrice = parseInt(productPriceText.replace(/\D/g, ''));
                // Проверяем авторизацию
                const token = localStorage.getItem('token');
                if (!token) {
                    openModal();
                    alert('Для добавления товара в корзину необходимо войти в систему');
                    return;
                }
                // Отправляем запрос на сервер
                const response = await fetch('/api/cart/add', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({
                        product_id: parseInt(productId),
                        product_name: productName,
                        price: productPrice,
                        quantity: 1
                    })
                });
                const data = await response.json();
                if (!response.ok) {
                    throw new Error(data.error || 'Ошибка при добавлении в корзину');
                }
                alert('Товар добавлен в корзину!');
                // Можно обновить счетчик корзины в шапке сайта, если он есть
            } catch (error) {
                console.error('Ошибка:', error);
                alert(error.message);
            }
        });
    </script>
    <script>
        // Загружаем данные о товаре
        async function loadProduct() {
            document.querySelector('.product-tabs .tab-btn').classList.add('active');
            document.querySelector('.product-tabs .tab-content').classList.add('active');
            try {
                const urlParams = new URLSearchParams(window.location.search);
                const productId = urlParams.get('id');
                if (!productId) {
                    console.error('ID товара не определен');
                    return;
                }
                // Загружаем основную информацию о товаре
                const productResponse = await fetch(`/api/product/${productId}`);
                const productData = await productResponse.json();
                if (productData.success) {
                    const product = productData.product;
                    const specsResponse = await fetch(`/api/product/${productId}/specs`);
                    const specsData = await specsResponse.json();
                    const stockElement = document.getElementById('product-stock')
                    if (specsData.success && specsData.specs) {
                        renderProductSpecs(specsData.specs);
                    }
                    if (stockElement) {
                        if (product.stock_quantity > 0) {
                            stockElement.textContent = `В наличии (${product.stock_quantity} шт.)`;
                            stockElement.style.color = 'green';
                        } else {
                            stockElement.textContent = 'Нет в наличии';
                            stockElement.style.color = 'red';
                        }
                    }
                    // Загружаем информацию о бренде
                    const brandResponse = await fetch(`/api/brand/${product.brand_id}`);
                    if (brandResponse.ok) {
                        const brandData = await brandResponse.json();
                        if (brandData.success && brandData.brand) {
                            const brand = brandData.brand;
                            document.getElementById('brand-name').textContent = brand.brand_name;
                            document.getElementById('brand-logo').src = brand.brand_logo;
                            // Добавляем бренд в хлебные крошки
                            if (breadcrumbHistory) {
                                // Проверяем, нет ли уже бренда в истории
                                const hasBrand = breadcrumbHistory.some(item => 
                                    item.url.includes(`brand=${brand.brand_id}`)
                                );
                                if (!hasBrand) {
                                    breadcrumbHistory.push({
                                        title: brand.brand_name,
                                        url: `/MainHTML.html?brand=${brand.brand_id}`
                                    });
                                }
                            }
                        }
                    }
                    document.getElementById('product-name').textContent = product.product_name;
                    // Загружаем дополнительные изображения товара
                    const imagesResponse = await fetch(`/api/product-images/${productId}`);
                    const imagesData = await imagesResponse.json();
                    document.getElementById('product-code').textContent = product.product_code;
                    // Создаем массив изображений, начиная с main_image из products
                    let images = [];
                    // Добавляем основное изображение первым, если оно есть
                    if (product.main_image) {
                        images.push({
                            image_url: product.main_image,
                            is_main: true
                        });
                    }
                    // Проверяем наличие элемента перед обновлением
                    if (document.getElementById('rating-text')) {
                        updateRatingText(
                            product.rating || 0, 
                            product.reviews_count || 0
                        );
                    } else {
                        console.warn('Элемент для отображения рейтинга не найден');
                    }
                    updateRatingStars(product.rating || 0);
                    updateRatingText(product.rating || 0, product.reviews_count || 0);
                    // Добавляем остальные изображения из product_images
                    if (imagesData.success && imagesData.images.length > 0) {
                        images = images.concat(imagesData.images);
                    }
                    // Отображаем галерею
                    renderProductGallery(images);
                    // Остальные данные товара
                    document.getElementById('product-price').textContent = `${product.price.toLocaleString('ru-RU')} ₽`;
                    document.getElementById('product-description').textContent = product.description;
                    document.title = product.product_name + ' | 4CE Магазин';
                    // После загрузки описания товара
                    document.getElementById('product-description').innerHTML = product.description;
                    // После загрузки характеристик товара
                    if (product.specs) {
                        const specs = JSON.parse(product.specs);
                        let specsHTML = '<table class="specs-table">';
                        for (const [key, value] of Object.entries(specs)) {
                            specsHTML += `<tr><td>${key}</td><td>${value}</td></tr>`;
                        }
                        specsHTML += '</table>';
                        document.getElementById('product-specs-full').innerHTML = specsHTML;
                    }
                    // Характеристики
                    if (product.specs) {
                        const specs = JSON.parse(product.specs);
                        let specsHTML = '<ul>';
                        for (const [key, value] of Object.entries(specs)) {
                            specsHTML += `<li><strong>${key}:</strong> ${value}</li>`;
                        }
                        specsHTML += '</ul>';
                        document.getElementById('product-specs').innerHTML = specsHTML;
                    }
                    // Хлебные крошки
                    if (breadcrumbHistory) {
                        breadcrumbHistory.push({
                            title: product.product_name,
                            url: window.location.pathname + window.location.search
                        });
                        sessionStorage.setItem('breadcrumbs', JSON.stringify(breadcrumbHistory));
                        updateBreadcrumbs();
                    }
                } else {
                    document.getElementById('product-container').innerHTML = '<p>Товар не найден</p>';
                }
            } catch (error) {
                console.error('Ошибка загрузки товара:', error);
                document.getElementById('product-container').innerHTML = '<p>Ошибка загрузки данных</p>';
            }
        }
        // Функция для отображения характеристик
        function renderProductSpecs(specs) {
            const specsContainer = document.getElementById('product-specs-full');
            if (!specsContainer) return;
            let specsHTML = '<table class="specs-table">';
            // Перебираем все характеристики и создаем строки таблицы
            for (const [key, value] of Object.entries(specs)) {
                // Пропускаем технические поля
                if (key === 'product_id' || key === 'id' || key === 'created_at' || key === 'updated_at' || key === 'category_id') {
                    continue;
                }
                specsHTML += `
                    <tr>
                        <td>${formatSpecName(key)}</td>
                        <td>${value || '—'}</td>
                    </tr>
                `;
            }   
            specsHTML += '</table>';
            specsContainer.innerHTML = specsHTML;
        }
        const specTranslations = {
                'software': 'Программное обеспечение',
                'material_upholstery': 'Материал обивки',
                'color_upholstery': 'Цвет обивки',
                'armrests': 'Подлокотники',
                'backrest_reclining': 'Откидывание спинки',
                'load': 'Допустимая нагрузка, кг',
                'swing_mechanism': 'Механизм качания',
                'connection_type': 'Тип подключения',
                'material': 'Материал',
                'lighting': 'Подсветка',
                'charging_time': 'Время зарядки, ч',
                'buttons_count': 'Кол-во кнопок',
                'dpi': 'Максимальная чувствительность',
                'sensor_type': 'Модель сенсора',
                'interface': 'Интерфейс',
                'key_switch_type': 'Модель переключателей',
                'key_layout': 'Раскладка клавиатуры',
                'key_count': 'Кол-во клавиш',
                'backlight': 'Подсветка',
                'keycap_material': 'Материал кейкапов',
                'frame_material': 'Материал плейта',
                'dimensions': 'Размер в мм',
                'weight': 'Вес, гр',
                'polling_rate': 'Частота опроса, гц',
                'actuation_force': 'Сила нажатия, гр',
                'travel_distance': 'Длина пути, мм',
                'anti_ghosting': 'Анти-гостинг',
                'n_key_rollover': 'Роллер',
                'water_resistance': 'Защита от воды',
                'cable_length': 'Длина кабеля, см',
                'battery_life': 'Ёмкость аккумулятора, mah',
                'compatibility': 'Операционная система',
                'additional_features': 'Прочие функции',
            };
        // Форматирование названий характеристик (замените на вашу логику)
        function formatSpecName(specKey) {
            if (specTranslations[specKey]) {
                return specTranslations[specKey];
            }
            return specKey
                .replace(/_/g, ' ')
                .replace(/\b\w/g, l => l.toUpperCase());
            }
        function updateRatingStars(rating) {
            const starsContainer = document.getElementById('product-rating');
            const stars = Array.from(starsContainer.querySelectorAll('.star'));
            // Сбрасываем все звезды
            stars.forEach(star => star.classList.remove('active', 'half-active'));
            // Подсвечиваем звезды в зависимости от рейтинга
            stars.forEach((star, index) => {
                const starValue = index + 1;
                if (starValue <= Math.floor(rating)) {
                    // Полностью активная звезда
                    star.classList.add('active');
                } else if (starValue === Math.ceil(rating) && rating % 1 >= 0.5) {
                    // Половина звезды (округление вверх)
                    star.classList.add('half-active');
                }
            });
        }
        function updateRatingText(rating, reviewsCount) {
            const ratingText = document.getElementById('rating-text');
            // Проверка существования элемента
            if (!ratingText) {
                console.error('Элемент rating-text не найден в DOM');
                return;
            }
            // Округляем рейтинг
            const roundedRating = Math.round(rating * 10) / 10;
            // Формируем текст с проверкой количества отзывов
            let text = `${roundedRating}`;
            if (reviewsCount > 0) {
                text += ` на основании ${reviewsCount} ${getReviewsWord(reviewsCount)}`;
            } else {
                text += ' (нет отзывов)';
            }
            ratingText.textContent = text;
        }
        // Функция для правильного склонения слова "отзыв"
        function getReviewsWord(count) {
            const lastDigit = count % 10;
            const lastTwoDigits = count % 100;
            if (lastTwoDigits >= 11 && lastTwoDigits <= 19) {
                return 'отзывов';
            }
            if (lastDigit === 1) {
                return 'отзыв';
            }
            if (lastDigit >= 2 && lastDigit <= 4) {
                return 'отзыва';
            }
            return 'отзывов';
        }
        function renderProductGallery(images) {
            const mainImage = document.getElementById('main-product-image');
            const thumbnailsContainer = document.querySelector('.thumbnails-container');
            if (!images || images.length === 0) {
                // Если нет изображений, показываем заглушку
                mainImage.src = 'pictures/no-image.png';
                return;
            }
            // Устанавливаем первое изображение как основное
            mainImage.src = images[0].image_url;
            mainImage.style.cursor = 'zoom-in';
            mainImage.addEventListener('click', () => openFullscreen(images[0].image_url));
            // Очищаем контейнер миниатюр
            thumbnailsContainer.innerHTML = '';
            let isZoomed = false;
            document.getElementById('fullscreenImage').addEventListener('click', (e) => {
                e.stopPropagation();
                const img = document.getElementById('fullscreenImage');
                isZoomed = !isZoomed;
                img.classList.toggle('zoomed', isZoomed);
            });
            // Создаем миниатюры для всех изображений
            images.forEach((image, index) => {
                const thumbnail = document.createElement('img');
                thumbnail.src = image.image_url;
                thumbnail.alt = `Изображение товара ${index + 1}`;
                thumbnail.className = 'thumbnail';
                if (index === 0) thumbnail.classList.add('active');
                // Обработчик клика для миниатюры
                thumbnail.addEventListener('click', () => {
                    // Обновляем основное изображение
                    mainImage.src = image.image_url;
                    // Обновляем активную миниатюру
                    document.querySelectorAll('.thumbnail').forEach(thumb => {
                        thumb.classList.remove('active');
                    });
                    thumbnail.classList.add('active');
                });
                // Добавляем возможность открыть в полноэкранном режиме по двойному клику
                thumbnail.addEventListener('dblclick', () => {
                    openFullscreen(image.image_url);
                });
                thumbnailsContainer.appendChild(thumbnail);
            });
            // Добавляем обработчики для кнопок карусели
            document.querySelector('.carousel-prev').addEventListener('click', () => {
                thumbnailsContainer.scrollBy({ left: -100, behavior: 'smooth' });
            });
            document.querySelector('.carousel-next').addEventListener('click', () => {
                thumbnailsContainer.scrollBy({ left: 100, behavior: 'smooth' });
            });
        }
        // Функции для полноэкранного просмотра
        function openFullscreen(imageSrc) {
            const overlay = document.getElementById('fullscreenOverlay');
            const fullscreenImage = document.getElementById('fullscreenImage');

            fullscreenImage.src = imageSrc;
            overlay.style.display = 'flex';
            document.body.style.overflow = 'hidden';
        }
        function closeFullscreen() {
            const overlay = document.getElementById('fullscreenOverlay');
            overlay.style.display = 'none';
            document.body.style.overflow = 'auto';
        }
        // Закрытие по клику вне изображения
        document.getElementById('fullscreenOverlay').addEventListener('click', (e) => {
            if (e.target === document.getElementById('fullscreenOverlay')) {
                closeFullscreen();
            }
        });
        // Закрытие по ESC
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                closeFullscreen();
            }
        });
    </script>
    <script>
    // Функция для отображения товаров
    function displayProducts(products, containerId) {
        const container = document.getElementById(containerId);
        if (!products || products.length === 0) {
            container.innerHTML = '<p>Товары не найдены</p>';
            return;
        }
        container.innerHTML = products.map(product => `
            <div class="product">
                <a href="#">
                    <img src="${escapeHtml(product.main_image || 'pictures/no-image.png')}" 
                        alt="${escapeHtml(product.product_name)}">
                    <div class="product-title">${escapeHtml(product.product_name)}</div>
                </a>
                <div class="rating-stars" data-rating="${product.rating || 0}">
                    <span class="star" data-value="1">&#9733;</span>
                    <span class="star" data-value="2">&#9733;</span>
                    <span class="star" data-value="3">&#9733;</span>
                    <span class="star" data-value="4">&#9733;</span>
                    <span class="star" data-value="5">&#9733;</span>
                </div>
                <div class="price">${product.price.toLocaleString('ru-RU')} ₽</div>
            </div>
        `).join('');
        // Инициализация рейтинга
        initRatings();
    }
    // Загрузка новинок
    async function loadNewProducts() {
        try {
            const response = await fetch('/api/products/new');
            const data = await response.json();
            if (data.success) {
                displayProducts(data.products, 'new-products-grid');
            } else {
                console.error('Ошибка загрузки новинок:', data.error);
            }
        } catch (error) {
            console.error('Ошибка загрузки новинок:', error);
        }
    }
    // Загрузка лидеров продаж
    async function loadTopProducts() {
        try {
            const response = await fetch('/api/products/top');
            const data = await response.json();
            if (data.success) {
                displayProducts(data.products, 'top-products-grid');
            } else {
                console.error('Ошибка загрузки лидеров продаж:', data.error);
            }
        } catch (error) {
            console.error('Ошибка загрузки лидеров продаж:', error);
        }
    }
    </script>
    <script>
        async function loadCategories() {
            try {
                const response = await fetch('/api/categories');
                const data = await response.json();           
                if (data.success) {
                    displayCategories(data.categories);
                } else {
                    console.error('Ошибка загрузки категорий:', data.error);
                }
            } catch (error) {
                console.error('Ошибка загрузки категорий:', error);
            }
        }
        function displayCategories(categories) {
            const container = document.getElementById('categories-list');
            const groupedCategories = groupCategoriesByParent(categories);
            // Добавляем корневые категории
            if (groupedCategories[null]) {
                groupedCategories[null].forEach(category => {
                    const li = createCategoryElement(category);
                    // Добавляем подкатегории, если они есть
                    if (groupedCategories[category.category_id]) {
                        const subUl = document.createElement('ul');
                        subUl.className = 'subcategories';
                        groupedCategories[category.category_id].forEach(subCategory => {
                            subUl.appendChild(createCategoryElement(subCategory));
                        });   
                        li.appendChild(subUl);
                    }
                    container.appendChild(li);
                });
            }
        }
        function groupCategoriesByParent(categories) {
            // Сначала сортируем категории по category_id
            const sortedCategories = [...categories].sort((a, b) => a.category_id - b.category_id);
            
            return sortedCategories.reduce((acc, category) => {
                const parentId = category.parent_category_id;
                if (!acc[parentId]) {
                    acc[parentId] = [];
                }
                acc[parentId].push(category);
                return acc;
            }, {});
        }
        function createCategoryElement(category) {
            const li = document.createElement('li');
            const a = document.createElement('a');
            a.href = `/MainHTML.html?category=${category.category_id}`;
            // Используем иконку из базы данных или дефолтную
            const iconSrc = category.icon_class ? 
                `pictures/${category.icon_class}.png` : 
                'pictures/default-icon.png';
            a.innerHTML = `
                <img src="${iconSrc}" class="catalog-icon">
                ${category.category_name}
                <img src="pictures/Vector 4.png" class="vector-icon">
            `;
            a.addEventListener('click', async (e) => {
                e.preventDefault();
                // Сохраняем ID категории для использования в MainHTML.html
                sessionStorage.setItem('lastCategoryId', category.category_id);
                sessionStorage.setItem('lastCategory', category.category_name);
                // Переходим на главную страницу
                window.location.href = `/MainHTML.html?category=${category.category_id}`;
            });
            li.appendChild(a);
            return li;
        }
    </script>
    <script>
    // Глобальная переменная для хранения истории
    let breadcrumbHistory = [];
    // Инициализация хлебных крошек
    function initBreadcrumbs() {
        // Загружаем историю из sessionStorage или создаем новую
        breadcrumbHistory = JSON.parse(sessionStorage.getItem('breadcrumbs')) || [];
        // Добавляем категорию перед товаром, если она есть
        const lastCategory = sessionStorage.getItem('lastCategory');
        const lastCategoryId = sessionStorage.getItem('lastCategoryId');
        if (lastCategory && lastCategoryId) {
            // Проверяем, не добавлена ли уже категория
            const hasCategory = breadcrumbHistory.some(item => item.title === lastCategory);
            if (!hasCategory) {
                breadcrumbHistory.push({
                    title: lastCategory,
                    url: `/MainHTML.html?category=${lastCategoryId}`
                });
            }
        }
        updateBreadcrumbs();
    }
    // Обновление отображения крошек
    function updateBreadcrumbs() {
        const breadcrumbsContainer = document.getElementById('breadcrumbs');
        if (!breadcrumbsContainer) return;
        // Очищаем все, кроме первого элемента (Главная)
        while (breadcrumbsContainer.children.length > 1) {
            breadcrumbsContainer.removeChild(breadcrumbsContainer.lastChild);
        }
        breadcrumbHistory.forEach((item, index) => {
            // Пропускаем главную страницу, так как она уже есть
            if (item.url === '/MainHTML.html') return;
            // Создаем разделитель
            const separator = document.createElement('span');
            separator.textContent = ' » ';
            breadcrumbsContainer.appendChild(separator);
            // Создаем элемент крошки
            const crumb = document.createElement('div');
            crumb.className = 'breadcrumb-item';
            crumb.setAttribute('itemprop', 'itemListElement');
            crumb.setAttribute('itemscope', '');
            crumb.setAttribute('itemtype', 'https://schema.org/ListItem');
            // Если это последний элемент - делаем его неактивной ссылкой
            if (index === breadcrumbHistory.length - 1) {
                crumb.innerHTML = `
                    <span class="brmtext" itemprop="item">
                        <span itemprop="name">${item.title}</span>
                    </span>
                    <meta itemprop="position" content="${index + 2}">
                `;
            } else {
                // Остальные элементы - ссылки
                crumb.innerHTML = `
                    <a href="${item.url}" itemprop="item">
                        <span itemprop="name">${item.title}</span>
                    </a>
                    <meta itemprop="position" content="${index + 2}">
                `;
            }
            breadcrumbsContainer.appendChild(crumb);
        });
    }
</script>
<script>
    // Показать/скрыть форму отзыва
    function showReviewForm() {
        const token = localStorage.getItem('token');
        if (!token) {
            openModal();
            alert('Для добавления отзыва необходимо войти в систему');
            return;
        }
        document.getElementById('review-form-container').style.display = 'block';
    }
    function hideReviewForm() {
        document.getElementById('review-form-container').style.display = 'none';
        document.getElementById('review-form').reset();
        document.querySelectorAll('.rating-input .star').forEach(star => {
            star.classList.remove('active');
        });
        document.getElementById('review-rating').value = '0';
    }
    // Инициализация рейтинга в форме
    document.querySelectorAll('.rating-input .star').forEach(star => {
        star.addEventListener('click', function() {
            const value = parseInt(this.getAttribute('data-value'));
            document.getElementById('review-rating').value = value;
            // Обновляем отображение звезд
            document.querySelectorAll('.rating-input .star').forEach((s, index) => {
                if (index < value) {
                    s.classList.add('active');
                } else {
                    s.classList.remove('active');
                }
            });
        });
    });
    // Обработка отправки формы отзыва
    document.getElementById('review-form').addEventListener('submit', async function(e) {
    e.preventDefault();
    const token = localStorage.getItem('token');
    if (!token) {
        alert('Для отзыва требуется авторизация');
        openModal();
        return;
    }
    const productId = new URLSearchParams(window.location.search).get('id');
    const rating = parseInt(document.getElementById('review-rating').value);
    // Получаем все три поля
    const reviewData = {
        product_id: productId,
        rating: rating,
        pros: document.getElementById('review-pros').value.trim(),
        cons: document.getElementById('review-cons').value.trim(),
        comment: document.getElementById('review-comment').value.trim()
    };
    try {
        const response = await fetch('/api/reviews/add', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${token}`
        },
        body: JSON.stringify(reviewData)
        });
        const data = await response.json();
        if (!response.ok) throw new Error(data.error || 'Ошибка сервера');
        alert('Отзыв опубликован!');
        hideReviewForm();
        loadProductReviews(); // Обновляем список отзывов
    } catch (error) {
        console.error('Ошибка:', error);
        alert(error.message);
    }
    });
    // Функция для переключения вкладок товара
    function showProductTab(tabId, event = null) {
        if (event) {
            event.preventDefault();
        }
        // Скрываем все содержимое вкладок
        document.querySelectorAll('.product-tabs .tab-content').forEach(tab => {
            tab.classList.remove('active');
        });
        // Убираем активный класс у всех кнопок
        document.querySelectorAll('.product-tabs .tab-btn').forEach(btn => {
            btn.classList.remove('active');
        });
        // Показываем выбранную вкладку
        document.getElementById(tabId).classList.add('active');
        // Добавляем активный класс к выбранной кнопке
        if (event) {
            event.currentTarget.classList.add('active');
        } else {
            document.querySelector(`.product-tabs .tab-btn[onclick*="${tabId}"]`).classList.add('active');
        }
        // При переключении на вкладку "Отзывы" загружаем их
        if (tabId === 'reviews') {
            loadProductReviews();
        }
    }
    // Функция для загрузки отзывов
    async function loadProductReviews() {
        try {
            const urlParams = new URLSearchParams(window.location.search);
            const productId = urlParams.get('id');
            if (!productId) return;
            const response = await fetch(`/api/product/${productId}/reviews`);
            const data = await response.json();
            if (data.success) {
                // Обновляем статистику рейтинга
                updateRatingStatistics(data.reviews, data.stats);
                if (data.reviews.length > 0) {
                    let reviewsHTML = '<div class="reviews-list">';
                    data.reviews.forEach(review => {
                        reviewsHTML += `
                            <div class="review">
                                <div class="review-header">
                                    <span class="review-author">${review.author}</span>
                                    <div class="review-rating">
                                        ${'★'.repeat(review.rating)}${'☆'.repeat(5 - review.rating)}
                                    </div>
                                    <span class="review-date">${new Date(review.created_at).toLocaleDateString()}</span>
                                </div>
                                <div class="review-text"><p style='font-weight: 600; font-size: 16px'>Достоинства:</p>${review.pros}</div>
                                <div class="review-text"><p style='font-weight: 600; font-size: 16px'>Недостатки:</p>${review.cons}</div>
                                <div class="review-text"><p style='font-weight: 600; font-size: 16px'>Комментарий:</p>${review.comment}</div>
                            </div>
                        `;
                    });               
                    reviewsHTML += '</div>';
                    document.getElementById('reviews-list').innerHTML = reviewsHTML;
                } else {
                    document.getElementById('reviews-list').innerHTML = '<p>Пока нет отзывов</p>';
                }
            } else {
                document.getElementById('reviews-list').innerHTML = '<p>Ошибка загрузки отзывов</p>';
            }
        } catch (error) {
            console.error('Ошибка загрузки отзывов:', error);
            document.getElementById('reviews-list').innerHTML = '<p>Ошибка загрузки отзывов</p>';
        }
    }
    // Обновленная функция для отображения статистики рейтинга
    function updateRatingStatistics(reviews, stats) {
        const averageRating = stats?.average_rating || 0;
        const totalReviews = stats?.total_reviews || 0;
        const recommendationPercentage = stats?.recommended_percentage || 0;
        // Обновляем средний рейтинг и количество отзывов
        document.getElementById('average-rating-value').textContent = 
            `${averageRating.toFixed(1)} на основании ${totalReviews} ${getReviewsWord(totalReviews)}`;
        // Обновляем процент рекомендаций
        document.getElementById('recommendation-percentage').textContent = 
            `${recommendationPercentage}% покупателей рекомендуют этот товар`;
        // Обновляем распределение рейтингов
        if (reviews && reviews.length > 0) {
            const ratingDistribution = [0, 0, 0, 0, 0];
            reviews.forEach(review => {
                ratingDistribution[5 - review.rating]++;
            });       
            let distributionHTML = '';
            for (let i = 5; i >= 1; i--) {
                distributionHTML += `<p>${'★'.repeat(i)} (${ratingDistribution[5 - i]})</p>`;
            }
            document.getElementById('rating-stars-distribution').innerHTML = distributionHTML;
        } else {
            document.getElementById('rating-stars-distribution').innerHTML = `
                <p>★★★★★ (0)</p>
                <p>★★★★★ (0)</p>
                <p>★★★★★ (0)</p>
                <p>★★★★★ (0)</p>
                <p>★★★★★ (0)</p>
            `;
        }
    }
</script>
<script>
    // Обработчик кнопки сравнения
    document.getElementById('compareButton').addEventListener('click', async function() {
        try {
            const urlParams = new URLSearchParams(window.location.search);
            const productId = urlParams.get('id');
            if (!productId) {
                alert('Ошибка: ID товара не определен');
                return;
            }
            // Проверяем авторизацию
            const token = localStorage.getItem('token');
            if (!token) {
                openModal();
                alert('Для сравнения товаров необходимо войти в систему');
                return;
            }
            // Проверяем, добавлен ли уже товар в сравнения
            const isInCompareList = await checkIfInCompareList(productId);
            if (isInCompareList) {
                // Если товар уже в списке - удаляем его
                const response = await fetch('/api/compare/remove', {
                    method: 'DELETE',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({
                        product_id: parseInt(productId)
                    })
                });
                const data = await response.json();
                if (!response.ok) {
                    throw new Error(data.error || 'Ошибка при удалении из сравнений');
                }
                alert(data.message || 'Товар удален из списка сравнений!');
                this.classList.remove('added-to-compare');
            } else {
                // Если товара нет в списке - добавляем его
                // Получаем данные о товаре, чтобы узнать category_id
                const productResponse = await fetch(`/api/product/${productId}`);
                const productData = await productResponse.json();
                if (!productData.success) {
                    throw new Error('Не удалось получить данные о товаре');
                }
                // Отправляем запрос на добавление в сравнения
                const response = await fetch('/api/compare/add', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({
                        product_id: parseInt(productId),
                        category_id: productData.product.category_id
                    })
                });
                const data = await response.json();
                if (!response.ok) {
                    throw new Error(data.error || 'Ошибка при добавлении в сравнения');
                }
                alert(data.message || 'Товар добавлен в список сравнений!');
                this.classList.add('added-to-compare');
            }
        } catch (error) {
            console.error('Ошибка:', error);
            alert(error.message);
        }
    });
    // Обработчик кнопки "В избранное"
    document.getElementById('wishlistButton').addEventListener('click', async function() {
        try {
            const urlParams = new URLSearchParams(window.location.search);
            const productId = urlParams.get('id');
            if (!productId) {
                alert('Ошибка: ID товара не определен');
                return;
            }
            // Проверяем авторизацию
            const token = localStorage.getItem('token');
            if (!token) {
                openModal();
                alert('Для добавления товара в избранное необходимо войти в систему');
                return;
            }
            // Проверяем, есть ли уже товар в избранном
            const isInWishlist = await checkIfInWishlist(productId);
            if (isInWishlist) {
                // Если товар уже в избранном - удаляем его
                const response = await fetch('/api/wishlist/remove/' + productId, {
                    method: 'DELETE',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    }
                });
                const data = await response.json();
                if (!response.ok) {
                    throw new Error(data.error || 'Ошибка при удалении из избранного');
                }
                alert('Товар удален из избранного');
                this.classList.remove('in-wishlist');
            } else {
                // Если товара нет в избранном - добавляем его
                const response = await fetch('/api/wishlist/add', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({
                        product_id: parseInt(productId)
                    })
                });
                const data = await response.json();
                if (!response.ok) {
                    throw new Error(data.error || 'Ошибка при добавлении в избранное');
                }
                alert('Товар добавлен в избранное!');
                this.classList.add('in-wishlist');
            }
        } catch (error) {
            console.error('Ошибка:', error);
            alert(error.message);
        }
    });
</script>
<script>
    async function checkIfInCompareList(productId) {
        const token = localStorage.getItem('token');
        if (!token) return false;
        try {
            const response = await fetch(`/api/compare/check?product_id=${productId}`, {
                headers: {
                    'Authorization': `Bearer ${token}`
                }
            });
            const data = await response.json();
            return data.success && data.inCompareList;
        } catch (error) {
            console.error('Ошибка проверки списка сравнений:', error);
            return false;
        }
    }
    async function checkIfInWishlist(productId) {
        const token = localStorage.getItem('token');
        if (!token) return false;
        try {
            const response = await fetch(`/api/wishlist/check?product_id=${productId}`, {
                headers: {
                    'Authorization': `Bearer ${token}`
                }
            });
            
            const data = await response.json();
            return data.success && data.inWishlist;
        } catch (error) {
            console.error('Ошибка проверки избранного:', error);
            return false;
        }
    }
    // И при загрузке товара:
    document.addEventListener('DOMContentLoaded', async () => {
        checkAuth();
        loadProduct();
        loadCategories();
        const urlParams = new URLSearchParams(window.location.search);
        const productId = urlParams.get('id');
        if (productId && await checkIfInCompareList(productId)) {
            document.getElementById('compareButton').classList.add('added-to-compare');
        }
        if (productId && await checkIfInWishlist(productId)) {
            document.querySelector('.icon-button img[alt="В избранное"]').closest('button').classList.add('in-wishlist');
        }})
</script>
<script>
    // Поиск товаров
    document.querySelector('.poisk_tovary').addEventListener('submit', async function(e) {
        e.preventDefault();
        const query = this.query.value.trim();
        if (query) {
            try {
                const response = await fetch(`http://localhost:3000/api/search?query=${encodeURIComponent(query)}`);
                const data = await response.json();
                
                if (data.success) {
                    displaySearchResults(data.products, query);
                } else {
                    showSearchError(data.error || 'Ошибка поиска');
                }
            } catch (error) {
                console.error('Ошибка поиска:', error);
                showSearchError('Ошибка соединения с сервером');
            }
        }
    });
    document.getElementById('resetSearch').addEventListener('click', function() {
        // Очищаем поле ввода
        document.querySelector('.poisk_tovary input').value = '';
        // Скрываем результаты поиска
        document.getElementById('searchResults').innerHTML = '';
        document.getElementById('searchResults').style.display = 'none';
        // Показываем стандартные секции (новинки, топы)
        document.getElementById('new-products').style.display = 'block';
        document.getElementById('top-products').style.display = 'block';
        document.getElementById('category-products').style.display = 'none';
        // Скрываем подсказки автодополнения, если они есть
        suggestionsContainer.style.display = 'none';
    });
    function initRatings() {
        document.querySelectorAll('.rating-stars').forEach(ratingContainer => {
            const rating = parseFloat(ratingContainer.getAttribute('data-rating')) || 0;
            const stars = Array.from(ratingContainer.querySelectorAll('.star'));
            // Сбрасываем все звезды
            stars.forEach(star => star.classList.remove('active', 'half-active'));
            // Подсвечиваем слева направо
            stars.forEach((star, index) => {
                if (index < rating) {
                    star.classList.add('active');
                } else if (index < Math.ceil(rating) && rating % 1 >= 0.5) {
                    star.classList.add('half-active');
                }
            });
            // Обработка наведения
            stars.forEach((star, index) => {
                star.addEventListener('mouseenter', () => {
                    // При наведении на звезду подсвечиваем все слева до нее
                    stars.forEach((s, i) => {
                        s.classList.toggle('hover', i <= index);
                    });
                });
                star.addEventListener('mouseleave', () => {
                    stars.forEach(s => s.classList.remove('hover'));
                });
            });
        });
    }
    // Автодополнение
    const searchInput = document.querySelector('.poisk_tovary input[name="query"]');
    const resetBtn = document.getElementById('resetSearch');
    const suggestionsContainer = document.createElement('div');
    suggestionsContainer.className = 'search-suggestions';
    searchInput.parentNode.insertBefore(suggestionsContainer, searchInput.nextSibling);
    searchInput.addEventListener('input', async function() {
        const query = this.value.trim();
        if (query.length >= 2) {
            try {
                const response = await fetch(`/api/search/suggest?query=${encodeURIComponent(query)}`);
                const suggestions = await response.json();
                showSuggestions(suggestions);
            } catch (error) {
                console.error('Ошибка автодополнения:', error);
            }
        } else {
            suggestionsContainer.style.display = 'none';
        }
    });
    // Отображение результатов поиска
    function displaySearchResults(products, query) {
        const resultsContainer = document.getElementById('searchResults');
        if (!products || products.length === 0) {
            resultsContainer.innerHTML = `
                <div class="no-results">
                    <p>По запросу "${escapeHtml(query)}" ничего не найдено</p>
                </div>
            `;
            return;
        }
        resultsContainer.innerHTML = `
            <div class="search-header">
                <h3>Результаты поиска: "${escapeHtml(query)}"</h3>
                <div class="search-count">Найдено: ${products.length} товаров</div>
            </div>
            <div class="products-grid">
                ${products.map(product => `
                    <div class="product">
                        <a href="#">
                            <img src="${escapeHtml(product.main_image || 'pictures/no-image.png')}" 
                                alt="${escapeHtml(product.product_name)}">
                            <div class="product-title">${escapeHtml(product.product_name)}</div>
                        </a>
                        <div class="rating-stars" data-rating="${product.rating || 0}">
                            <span class="star" data-value="1">&#9733;</span>
                            <span class="star" data-value="2">&#9733;</span>
                            <span class="star" data-value="3">&#9733;</span>
                            <span class="star" data-value="4">&#9733;</span>
                            <span class="star" data-value="5">&#9733;</span>
                        </div>
                        <div class="price">${product.price.toLocaleString('ru-RU')} ₽</div>
                    </div>
                `).join('')}
            </div>
        `;
        // Инициализация рейтинга для новых товаров
        initRatings();
    }
    // Показ подсказок автодополнения
    function showSuggestions(suggestions) {
        if (suggestions.length === 0) {
            suggestionsContainer.style.display = 'none';
            return;
        }
        suggestionsContainer.innerHTML = suggestions.map(item => `
            <div class="suggestion-item">${escapeHtml(item)}</div>
        `).join('');
        suggestionsContainer.style.display = 'block'; 
        // Обработка клика по подсказке
        suggestionsContainer.querySelectorAll('.suggestion-item').forEach(item => {
            item.addEventListener('click', () => {
                searchInput.value = item.textContent;
                suggestionsContainer.style.display = 'none';
                document.querySelector('.poisk_tovary').dispatchEvent(new Event('submit'));
            });
        });
    }
    // Обработка ошибок поиска
    function showSearchError(message) {
        const resultsContainer = document.getElementById('searchResults');
        resultsContainer.innerHTML = `
            <div class="search-error">
                <p>${escapeHtml(message)}</p>
            </div>
        `;
    }
    // Закрытие подсказок при клике вне поля поиска
    document.addEventListener('click', (e) => {
        if (e.target !== searchInput) {
            suggestionsContainer.style.display = 'none';
        }
    });
    // Экранирование HTML
    function escapeHtml(unsafe) {
        return unsafe
            .replace(/-/g, "\ ")
            .replace(/&/g, "&amp;")
            .replace(/</g, "&lt;")
            .replace(/>/g, "&gt;")
            .replace(/"/g, "&quot;")
            .replace(/'/g, "&#039;");
    }
</script>
</body>
</html>